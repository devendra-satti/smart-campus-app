<%- include('../layout', { title: title, username: username }) %>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">Edit Announcement</h4>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="_method" value="PUT">
                    
                    <div class="mb-3">
                        <label for="title" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="title" name="title" required 
                               value="<%= announcement.title %>" 
                               placeholder="e.g., Important Exam Schedule Update">
                    </div>

                    <div class="mb-3">
                        <label for="content" class="form-label">Content *</label>
                        <textarea class="form-control" id="content" name="content" rows="5" required 
                                  placeholder="Enter the announcement details..."><%= announcement.content %></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">Category *</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="academic" <%= announcement.category === 'academic' ? 'selected' : '' %>>Academic</option>
                                <option value="event" <%= announcement.category === 'event' ? 'selected' : '' %>>Event</option>
                                <option value="important" <%= announcement.category === 'important' ? 'selected' : '' %>>Important</option>
                                <option value="general" <%= announcement.category === 'general' ? 'selected' : '' %>>General</option>
                                <option value="emergency" <%= announcement.category === 'emergency' ? 'selected' : '' %>>Emergency</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="targetAudience" class="form-label">Target Audience *</label>
                            <select class="form-select" id="targetAudience" name="targetAudience" required>
                                <option value="all" <%= announcement.targetAudience === 'all' ? 'selected' : '' %>>All Students</option>
                                <option value="faculty" <%= announcement.targetAudience === 'faculty' ? 'selected' : '' %>>Faculty Only</option>
                                <option value="specific" <%= announcement.targetAudience === 'specific' ? 'selected' : '' %>>Specific Groups</option>
                            </select>
                        </div>
                    </div>

                    <!-- Specific groups field -->
                    <div class="mb-3" id="specificGroupsContainer" style="display: none;">
                        <label for="specificGroups" class="form-label">Specific Groups</label>
                        <input type="text" class="form-control" id="specificGroups" name="specificGroups" 
                               value="<%= announcement.specificGroups || '' %>"
                               placeholder="e.g., CSE 3rd Year, MBA Students">
                        <div class="form-text">Comma-separated list of specific groups</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="expiryDate" class="form-label">Expiry Date (Optional)</label>
                            <input type="date" class="form-control" id="expiryDate" name="expiryDate" 
                                   value="<%= announcement.expiryDate ? new Date(announcement.expiryDate).toISOString().split('T')[0] : '' %>">
                            <div class="form-text">Leave empty if announcement doesn't expire</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="priority" class="form-label">Priority</label>
                            <select class="form-select" id="priority" name="priority">
                                <option value="normal" <%= announcement.priority === 'normal' ? 'selected' : '' %>>Normal</option>
                                <option value="high" <%= announcement.priority === 'high' ? 'selected' : '' %>>High</option>
                                <option value="urgent" <%= announcement.priority === 'urgent' ? 'selected' : '' %>>Urgent</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="attachment" class="form-label">Attachment (Optional)</label>
                        <% if (announcement.attachmentUrl) { %>
                            <div class="mb-2">
                                <strong>Current Attachment:</strong>
                                <a href="<%= announcement.attachmentUrl %>" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-paperclip me-1"></i>View Current
                                </a>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="removeAttachment" name="removeAttachment">
                                    <label class="form-check-label" for="removeAttachment">
                                        Remove current attachment
                                    </label>
                                </div>
                            </div>
                        <% } %>
                        <input type="file" class="form-control" id="attachment" name="attachment" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                        <div class="form-text">Supported formats: PDF, DOC, DOCX, JPG, JPEG, PNG</div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sendNotification" name="sendNotification">
                            <label class="form-check-label" for="sendNotification">
                                Send update notification to target audience
                            </label>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i>
                        Editing this announcement will update it for all users. Consider sending a notification if the changes are significant.
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="/announcements/<%= announcement._id %>" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary me-md-2">
                            <i class="fas fa-save me-1"></i>Update Announcement
                        </button>
                        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Announcement History -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Announcement History</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Created:</strong> <%= new Date(announcement.createdAt).toLocaleString() %><br>
                    <strong>By:</strong> <%= announcement.postedBy.username %>
                </div>
                <div>
                    <strong>Last Updated:</strong> <%= new Date(announcement.updatedAt).toLocaleString() %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this announcement?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="/announcements/<%= announcement._id %>" class="d-inline">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-danger">Delete Announcement</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Show/hide specific groups field based on target audience selection
document.addEventListener('DOMContentLoaded', function() {
    const targetAudience = document.getElementById('targetAudience');
    const specificGroupsContainer = document.getElementById('specificGroupsContainer');
    
    // Set initial state
    if (targetAudience.value === 'specific') {
        specificGroupsContainer.style.display = 'block';
    }
    
    targetAudience.addEventListener('change', function() {
        if (this.value === 'specific') {
            specificGroupsContainer.style.display = 'block';
        } else {
            specificGroupsContainer.style.display = 'none';
        }
    });
});
</script>
